window.dataLayer = window.dataLayer || [];

function gtag() {
    dataLayer.push(arguments);
}
var gsfLoadScript = function(url, callback) {
    var script = document.createElement('script');
    script.type = 'text/javascript';
    if (script.readyState) {
        script.onreadystatechange = function() {
            if (script.readyState == 'loaded' || script.readyState == 'complete') {
                script.onreadystatechange = null;
                callback();
            }
        };
    } else {
        script.onload = function() {
            callback();
        };
    }
    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
};
var generateProductIds = function(items) {
    var gsf_pids = [];
    for (var i = 0; i < items.length; i++) {
        var gsf_pid = 'shopify_AU' + '_' + items[i].product_id + '_' + items[i].variant_id;
        if (parseInt('0') === 1) {
            gsf_pid = items[i].sku;
        } else if (parseInt('0') === 2) {
            gsf_pid = items[i].variant_id;
        }
        gsf_pids.push(gsf_pid);
    }
    return gsf_pids;
};
var prepareAdditionalEvent = function(gsf_jQuery) {
    function prepareAddtoCart() {
        gsf_jQuery("form[action^='/cart/add']").on('submit', function(e) {
            if (!(e.defaultPrevented || e.isDefaultPrevented && e.isDefaultPrevented())) {
                triggerAddToCart(false);
            }
        });
        var _generic_ajax_open = XMLHttpRequest.prototype.open;
        var _generic_ajax_send = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.open = function(method, url) {
            this._method = method;
            this._url = url;
            _generic_ajax_open.apply(this, arguments);
        };
        XMLHttpRequest.prototype.send = function() {
            this.addEventListener('readystatechange', function() {
                if (this.readyState === XMLHttpRequest.DONE) {
                    if (this._url.indexOf('/cart/add') !== -1) {
                        var cart_item = JSON.parse(this.responseText);
                        triggerAddToCart(cart_item);
                    }
                }
            });
            _generic_ajax_send.apply(this, arguments);
        }
    }

    function prepareCheckout() {
        gsf_jQuery(':submit', gsf_jQuery("form[action='/cart']")).on('click', function(e) {
            if (gsf_jQuery(this).attr('name') == 'checkout') {
                triggerCheckout();
            }
        });
        gsf_jQuery(document).on('click', '.shopify-payment-button', function(e) {
            if (gsf_conversion_data && gsf_conversion_data.page_type && (gsf_conversion_data.page_type == 'cart' || gsf_conversion_data.page_type == 'product') && gsf_conversion_data.data.total_price > 0) {
                gtag('event', 'conversion', {
                    'send_to': 'AW-880950587/oCuECM2mlLMBELv6iKQD',
                    'value': gsf_conversion_data.data.total_price
                });
            } else {
                gtag('event', 'conversion', {
                    'send_to': 'AW-880950587/oCuECM2mlLMBELv6iKQD',
                });
            }
        });
    }

    function triggerCheckout() {
        if (gsf_conversion_data && gsf_conversion_data.page_type && gsf_conversion_data.page_type == 'cart' && gsf_conversion_data.data.total_price > 0) {
            gtag('event', 'conversion', {
                'send_to': 'AW-880950587/oCuECM2mlLMBELv6iKQD',
                'value': gsf_conversion_data.data.total_price
            });
        } else {
            gsf_jQuery.ajax({
                type: 'GET',
                url: 'https://white-green-au.myshopify.com/cart.js?t=' + Date.now(),
                dataType: 'json',
                success: function(response) {
                    if (response && response.total_price && response.total_price > 0) {
                        gtag('event', 'conversion', {
                            'send_to': 'AW-880950587/oCuECM2mlLMBELv6iKQD',
                            'value': response.total_price
                        });
                    }
                },
            });
        }
    }

    function triggerAddToCart(cart_item) {
        var gsf_gtag_args = {
            send_to: 'AW-880950587',
            ecomm_pagetype: 'cart'
        };
        if (cart_item) {
            gsf_gtag_args.ecomm_prodid = generateProductIds([cart_item]);
            gsf_gtag_args.ecomm_totalvalue = parseFloat((cart_item.price / 100).toFixed(2));
        } else {
            gsf_gtag_args.ecomm_prodid = generateProductIds(gsf_conversion_data.data.product_data);
            gsf_gtag_args.ecomm_totalvalue = gsf_conversion_data.data.total_price;
        }
        if (gsf_gtag_args.ecomm_totalvalue && gsf_gtag_args.ecomm_totalvalue > 0) {
            gtag('event', 'add_to_cart', gsf_gtag_args);
            gtag('event', 'conversion', {
                'send_to': 'AW-880950587/89gnCIqchLMBELv6iKQD',
                'value': gsf_gtag_args.ecomm_totalvalue
            });
        }
    }
    prepareAddtoCart();
    prepareCheckout();
};

function gsfLoadjQuery() {
    if (!window.jQuery || typeof jQuery === 'undefined') {
        gsfLoadScript('//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js', function() {
            gsf_jQuery = jQuery.noConflict(true);
            prepareAdditionalEvent(gsf_jQuery);
        });
    } else {
        prepareAdditionalEvent(jQuery);
    }
}

function initGoogleTracker() {
    gsfLoadjQuery();
    gtag('js', new Date()); /* gtag('config', 'AW-880950587'); // remove for now 11319 */
    var gsf_shopify_checkout = Shopify.checkout || [];
    var gsf_line_items = gsf_shopify_checkout.line_items || [];
    if (location.href.includes('thank_you') && Shopify.checkout.total_price && gsf_line_items.length > 0) {
        var total_price = Shopify.checkout.total_price || 0;
        gtag('event', 'conversion', {
            'send_to': 'AW-880950587/YtwICJ_okLMBELv6iKQD',
            'value': total_price,
            'currency': Shopify.checkout.currency,
            'transaction_id': Shopify.checkout.order_id,
        });
    }
    if (typeof gsf_conversion_data != 'undefined' && typeof gsf_conversion_data.page_type != 'undefined' && typeof gsf_conversion_data.event != 'undefined' && gsf_conversion_data.page_type !== '' && gsf_conversion_data.event !== '') {
        var gsf_gtag_args = {
            send_to: 'AW-880950587',
            ecomm_pagetype: gsf_conversion_data.page_type
        };
        gsf_gtag_args.ecomm_prodid = generateProductIds(gsf_conversion_data.data.product_data);
        gsf_gtag_args.ecomm_totalvalue = gsf_conversion_data.data.total_price;
        gtag('event', 'page_view', gsf_gtag_args);
    }
    var gsf_shopify_checkout = Shopify.checkout || [];
    var gsf_line_items = gsf_shopify_checkout.line_items || [];
    if (gsf_line_items.length > 0 && location.href.includes('thank_you')) {
        var product_data = [];
        var total_price = Shopify.checkout.total_price || 0;
        for (i in gsf_line_items) {
            var item = gsf_line_items[i];
            var p_data = {
                variant_id: item.variant_id,
                product_id: item.product_id,
                name: item.title,
                price: item.price,
                currency: Shopify.checkout.currency,
                sku: item.sku,
                brand: item.vendor,
                variant: item.variant_title,
                category: ''
            };
            product_data.push(p_data);
        }
        gtag('event', 'page_view', {
            'send_to': 'AW-880950587',
            'ecomm_pagetype': 'purchase',
            'ecomm_prodid': generateProductIds(product_data),
            'ecomm_totalvalue': total_price,
        });
    }
}
var gsf_script = document.createElement('script');
gsf_script.src = 'https://www.googletagmanager.com/gtag/js?id=AW-880950587';
document.head.append(gsf_script);
gsf_script.onload = initGoogleTracker;
